import numpy as np
import matplotlib.pyplot as plt
import netCDF4
import pandas as pd
import matplotlib.dates as mdates
from datetime import datetime, timedelta


### set minimum length required to take the date into consideration:
len_min=100
len_min=500
len_min=1000
len_min=2000
len_min=3000
len_min=4000


### maximum difference in detected date allowed (in days)
days_mismatch=1
###

count_dates_D11=0
count_dates_edges=0
count_edge_in_D11=0
count_D11_in_edge=0


for year in range(1998,2008):
    #print(year)

    ## load edge length
    ncfile = netCDF4.Dataset('ERA5_qvi_Pacific_hourly_detected_rivers_sigmaS100_sigmaT1_percupper95_perclower90_'+str(year)+'_fldsum_daymean.nc', "r", format="NETCDF4")
    edges = ncfile.variables['outdata'][:,:,:]
    edges=np.squeeze(edges)
    
    
    ##### events detected by D11 et al., 2011:
    if year == 1998:        
        dates_California=['19980114','19980115','19980126','19980202','19980203','19980205','19980322','19980323','19980525','19980625','19981108','19981121','19981123']
        dates_OWBC=['19980123','19980322','19980609','19980614','19980615','19980624','19980706','19980712','19980713','19980714','19980715','19980716','19981005','19981006','19981012','19981017','19981113','19981114','19981121','19981125','19981228','19981229','19980717','19980723','19980724','19980809','19980812','19980813','19980827','19980830','19980901','19980902','19980903','19980907','19980908','19980911','19980913','19980924','19981005','19981006','19981012','19981017','19981113','19981114','19981121','19981125','19981228','19981229']
    
    if year == 1999:
        dates_California=['19990115','19990207','19990324','19990325','19990511','19990802','19990830','19991014','19991026','19991028','19991110','19991111','19991115']
        dates_OWBC=['19990110','19990114','19990224','19990227','19990511','19990531','19990604','19990623','19990628','19990629','19990720','19990726','19990728','19990729','19990802','19990817','19990818','19990819','19990821','19990822','19990823','19990824','19990825','19990826','19990827','19990828','19990829','19990904','19990905','19990923','19990929','19991008','19991013','19991017','19991030','19991103','19991106','19991111','19991112','19991113','19991114','19991125','19991215','19991216']
    
    if year == 2000:     
        dates_California=['20000116','20000117','20000118','20000124','20000125','20000305','20000417','20000507','20000508','20000523','20000612']
        dates_OWBC=['20000521','20000522','20000523','20000527','20000607','20000612','20000614','20000617','20000630','20000718','20000719','20000720','20000727','20000728','20000729','20000730','20000731','20000817','20000818','20000823','20000824','20000825','20000829','20000907','20000910','20000917','20000918','20000920','20000929','20000930']
    
    if year == 2001:        
        dates_California=['20010328','20010515','20010516','20010605','20010625','20010626','20010627','20010730','20010925','20010926','20011011','20011030','20011116','20011122','20011129','20011202','20011229']
        dates_OWBC=['20001001','20001008','20001017','20001022','20001023','20001123','20010430','20010606','20010620','20010703','20010707','20010709','20010802','20010803','20010805','20010821','20010822','20010825','20010828','20010830','20010901','20010903','20010910','20010912','20010921','20010922','20010923','20011010','20011104','20011109','20011114','20011115','20011119']
    
    if year == 2002:         
        dates_California=['20020102','20020106','20020414','20020529','20020618','20021107','20021108','20021109','20021213','20021214','20021216','20021227']
        dates_OWBC=['20020106','20020107','20020221','20020413','20020604','20020625','20020626','20020627','20020706','20020710','20020715','20020716','20020717','20020718','20020723','20020725','20020728','20020729','20020730','20020808','20020809','20020822','20020823','20020828','20020829','20020901','20020902','20020910','20020911','20020912','20020916','20021003','20021027','20021106','20021112','20021119','20021212']
    
    if year == 2003:         
        dates_California=['20030112','20030113','20030212','20030310','20030315','20030323','20030326','20030908','20031005','20031109','20031129','20031130','20031205','20031206','20031207','20031224']
        dates_OWBC=['20030102','20030126','20030131','20030313','20030523','20030524','20030527','20030626','20030709','20030711','20030712','20030714','20030720','20030818','20030821','20030825','20030831','20030903','20030904','20030905','20030906','20030911','20030914','20030918','20030922','20030923','20030925','20031006','20031016','20031017','20031018','20031019','20031020','20031021','20031022','20031027','20031129']
    
    if year == 2004:         
        dates_California=['20040216','20040217','20040527','20040528','20040911','20040917','20041009','20041018','20041026','20041227']
        dates_OWBC=['20040122','20040526','20040706','20040712','20040717','20040718','20040729','20040803','20040804','20040817','20040820','20040821','20040828','20040829','20040830','20040831','20040910','20040911','20040915','20040922','20040925','20041006','20041008','20041011','20041012','20041015','20041016','20041022','20041102','20041105','20041106','20041107','20041108','20041115','20041124','20041125','20041208','20041209','20041210','20041211','20041217']    
    
    if year == 2005:     
        dates_California=['20050109','20050110','20050322','20050504','20050508','20050515','20050516','20050519','20050522','20050608','20050609','20050617','20050709','20050710','20051026','20051107','20051108','20051125','20051129','20051201','20051202','20051222','20051228','20051230','20051231']
        dates_OWBC=['20050117','20050118','20050119','20050122','20050123','20050327','20050416','20050514','20050515','20050629','20050704','20050705','20050708','20050716','20050727','20050728','20050730','20050731','20050801','20050805','20050817','20050820','20050821','20050822','20050826','20050827','20050908','20050929','20050930','20051010','20051013','20051014','20051021','20051022','20051025','20051031','20051101','20051109','20051110','20051113','20051224','20051230']
    
    if year == 2006:     
        dates_California=['20060227','20060306','20060325','20060328','20060403','20060404','20060412','20060508','20060519','20060521','20060531','20060601','20060602','20060604','20061103','20061113','20061117','20061120','20061212']
        dates_OWBC=['20060117','20060531','20060616','20060708','20060709','20060714','20060720','20060726','20060805','20060808','20060828','20060908','20060911','20060917','20060918','20061008','20061015','20061019','20061026','20061106','20061107','20061225','20061226']
    
    if year == 2007:     
        dates_California=['20070209','20070210','20070605','20070610','20070628','20070718','20071019','20071028','20071029','20071111','20071204']
        dates_OWBC=['20070102','20070122','20070311','20070312','20070609','20070613','20070614','20070702','20070703','20070714','20070715','20070717','20070720','20070721','20070722','20070723','20070728','20070812','20070813','20070825','20070828','20070829','20070903','20070930','20071007','20071009','20071019','20071022','20071028','20071107','20071116','20071117','20071118','20071203','20071223']
    
    
    dates_D11 = dates_California + dates_OWBC
    
    #print(dates_D11)
    



    N=np.size(edges)
    
    dates = pd.date_range(start=str(year)+'-01-01', end=str(year)+'-12-31', freq='D')
    
    # remove leap days because they are not in the data
    leap = []
    for each in dates:
        if each.month==2 and each.day ==29:
            leap.append(each)
    dates_365days = dates.drop(leap)
    
    
    # dates of edges above minimum length 
    dates_detected=dates_365days[edges>len_min]
    
    count_dates_edges=count_dates_edges+np.shape(dates_detected)[0]
    
    ## scan through D11 dataset
    for date_int in dates_D11:
        date = datetime(year=int(date_int[0:4]), month=int(date_int[4:6]), day=int(date_int[6:8]))
        date_fmted=str(date_int[0:4])+'-'+str(date_int[4:6])+'-'+str(date_int[6:8])
    
        nextday=date+timedelta(days=1)
        prevday=date-timedelta(days=1)
        nextday_fmted=str(nextday)[0:10]
        prevday_fmted=str(prevday)[0:10]
    
        dayplus2=date+timedelta(days=2)
        daymin2=date-timedelta(days=2)
        dayplus2_fmted=str(dayplus2)[0:10]
        daymin2_fmted=str(daymin2)[0:10]


        count_dates_D11=count_dates_D11+1
        if days_mismatch == 1:
            if date_fmted in dates_detected or prevday_fmted in dates_detected or nextday_fmted in dates_detected:
                count_edge_in_D11=count_edge_in_D11+1
        elif days_mismatch == 2:
            if date_fmted in dates_detected or prevday_fmted in dates_detected or nextday_fmted in dates_detected or daymin2_fmted in dates_detected or dayplus2_fmted in dates_detected:
                count_edge_in_D11=count_edge_in_D11+1


    ## scan through D11 dataset
    for date in dates_detected:
        #date = datetime(year=int(date_int[0:4]), month=int(date_int[4:6]), day=int(date_int[6:8]))
        #print(date)
        #print(str(date)[0:10])

        #date_fmted=str(date)[0:10]
        date_fmted=str(date)[0:4]+str(date)[5:7]+str(date)[8:10]
   
        nextday=date+timedelta(days=1)
        prevday=date-timedelta(days=1)
        nextday_fmted=str(nextday)[0:4]+str(nextday)[5:7]+str(nextday)[8:10]
        prevday_fmted=str(prevday)[0:4]+str(prevday)[5:7]+str(prevday)[8:10]

        dayplus2=date+timedelta(days=2)
        daymin2=date-timedelta(days=2)
        dayplus2_fmted=str(dayplus2)[0:4]+str(dayplus2)[5:7]+str(dayplus2)[8:10]
        daymin2_fmted=str(daymin2)[0:4]+str(daymin2)[5:7]+str(daymin2)[8:10]
        if days_mismatch == 1:
            if date_fmted in dates_D11 or prevday_fmted in dates_D11 or nextday_fmted in dates_D11:
                count_D11_in_edge=count_D11_in_edge+1
        elif days_mismatch == 2:
            if date_fmted in dates_D11 or prevday_fmted in dates_D11 or nextday_fmted in dates_D11 or daymin2_fmted in dates_D11 or dayplus2_fmted in dates_D11:
                count_D11_in_edge=count_D11_in_edge+1


#print(count_dates_D11)
#print(count_dates_edges)

print('len_min: '+str(len_min))
print('days_mismatch: '+str(days_mismatch))
print('detected dates with edges: '+str(count_dates_edges))
print('Fraction of dates in D11 also detected with edge detection (%): '+str(float(count_edge_in_D11/count_dates_D11*100)))
print('Fraction of detected edges that also appear in D11 (%): '+str(float(count_D11_in_edge/count_dates_edges*100)))

print('dates in D11: '+str(count_dates_D11))






















quit()



